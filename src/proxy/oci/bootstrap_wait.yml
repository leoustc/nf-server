---
- name: Wait for nf-bootstrap systemd service
  hosts: all
  gather_facts: no

  vars:
    service_name: nf-bootstrap.service

  tasks:
    - name: Wait for SSH (retry if dropped)
      wait_for_connection:
        timeout: 600
        sleep: 10

    - name: Wait until nf-bootstrap service is finished
      shell: "systemctl is-active {{ service_name }} || true"
      register: svc_status
      retries: 288000            # ~8 hours at 10s intervals
      delay: 30
      until: svc_status.stdout in ['inactive', 'failed']
      changed_when: false
      failed_when: false
